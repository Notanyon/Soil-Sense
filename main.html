<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FarmAI - Smart Farming Assistant</title>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #6BBF59 0%, #2C6E49 100%);
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    header {
      padding: 2rem 1rem;
      text-align: center;
      background: rgba(0,0,0,0.2);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    header h1 {
      margin: 0 0 0.5rem;
      font-size: 2.75rem;
      letter-spacing: 2px;
    }
    header p {
      font-size: 1.25rem;
      font-weight: 300;
      max-width: 600px;
      margin: 0 auto;
      line-height: 1.45;
    }
    .api-key-container {
      max-width: 600px;
      margin: 1rem auto;
      background: rgba(255, 255, 255, 0.15);
      padding: 1rem 1.5rem;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      color: #fff;
    }
    .api-key-container label {
      font-weight: 600;
      margin-bottom: 0.3rem;
    }
    .api-key-container input {
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      border: none;
      font-size: 1rem;
      outline: none;
      font-family: monospace;
      margin-bottom: 0.75rem;
      color: #000;
    }
    .api-key-container button {
      background: #3B8D4F;
      border: none;
      color: white;
      font-weight: bold;
      font-size: 1rem;
      padding: 0.5rem 1.25rem;
      border-radius: 6px;
      cursor: pointer;
      align-self: flex-start;
      transition: background-color 0.3s ease;
    }
    .api-key-container button:hover {
      background: #2B6B3B;
    }
    .api-key-container .status {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      font-style: italic;
      color: #d2f8d2;
    }
    main {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1rem;
    }
    .chat-container {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      box-shadow: 0 4px 30px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 1.5rem;
      max-width: 600px;
      width: 100%;
      display: flex;
      flex-direction: column;
    }
    .chat-input {
      display: flex;
      margin-top: 1rem;
    }
    textarea {
      flex-grow: 1;
      resize: vertical;
      min-height: 80px;
      padding: 0.75rem;
      border-radius: 8px 0 0 8px;
      border: none;
      font-size: 1rem;
      outline:none;
      font-family: inherit;
    }
    button#sendBtn {
      background: #3B8D4F;
      border: none;
      color: white;
      font-weight: bold;
      font-size: 1.1rem;
      padding: 0 1.5rem;
      border-radius: 0 8px 8px 0;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button#sendBtn:hover:not(:disabled) {
      background: #2B6B3B;
    }
    button#sendBtn:disabled {
      cursor: not-allowed;
      background: #487a55;
    }
    .response {
      margin-top: 1.5rem;
      background: rgba(0,0,0,0.2);
      padding: 1rem;
      border-radius: 8px;
      min-height: 80px;
      white-space: pre-wrap;
      font-size: 1rem;
      word-break: break-word;
    }
    footer {
      text-align: center;
      padding: 1rem;
      font-size: 0.9rem;
      color: #ddd;
      background: rgba(0,0,0,0.1);
      margin-top: auto;
    }
    @media (max-width: 480px) {
      header h1 {
        font-size: 2rem;
      }
      header p {
        font-size: 1rem;
      }
      .api-key-container {
        margin: 1rem 0.5rem;
      }
      main {
        padding: 1rem 0.5rem;
      }
      .chat-container {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Soil Sense</h1>
    <p>Your Smart AI Assistant for Optimizing Crop Selection & Boosting Farm Yield</p>
  </header>

  <section class="api-key-container" aria-label="Gemini API Key Input">
    <label for="apiKeyInput">Enter your API Key:</label>
    <input type="password" id="apiKeyInput" placeholder="Your Gemini API Key" aria-describedby="keyStatus" />
    <button id="saveKeyBtn" aria-label="Save Gemini API Key">Save API Key</button>
    <div id="keyStatus" class="status" aria-live="polite"></div>
  </section>

  <main>
    <div class="chat-container" role="main" aria-label="Farm AI Chat Interface">
      <label for="userInput" style="font-weight:600; margin-bottom:0.5rem; display:block;">
        Ask FarmAI what to plant or any farming advice:
      </label>
      <div class="chat-input">
        <textarea id="userInput" placeholder="Type your question here..." aria-multiline="true" rows="4"></textarea>
        <button id="sendBtn" aria-label="Send question to FarmAI" disabled>Send</button>
      </div>
      <div id="response" class="response" aria-live="polite"></div>
    </div>
  </main>


<script type="module">
  import { GoogleGenAI } from "https://cdn.jsdelivr.net/npm/@google/genai/+esm";

  const apiKeyInput = document.getElementById('apiKeyInput');
  const saveKeyBtn = document.getElementById('saveKeyBtn');
  const keyStatus = document.getElementById('keyStatus');
  const sendBtn = document.getElementById('sendBtn');
  const userInput = document.getElementById('userInput');
  const responseDiv = document.getElementById('response');

  let ai = null;

  function loadApiKey() {
    const storedKey = localStorage.getItem('geminiApiKey');
    if (storedKey) {
      apiKeyInput.value = storedKey;
      keyStatus.textContent = 'API key loaded from storage.';
      sendBtn.disabled = false;
      ai = new GoogleGenAI({ apiKey: storedKey });
    } else {
      keyStatus.textContent = 'Please enter your Gemini API key above.';
      sendBtn.disabled = true;
    }
  }
  loadApiKey();

  saveKeyBtn.addEventListener('click', () => {
    const key = apiKeyInput.value.trim();
    if (!key) {
      keyStatus.textContent = 'API key cannot be empty.';
      sendBtn.disabled = true;
      ai = null;
      return;
    }
    localStorage.setItem('geminiApiKey', key);
    keyStatus.textContent = 'API key saved successfully!';
    sendBtn.disabled = false;
    ai = new GoogleGenAI({ apiKey: key });
  });

  async function queryFarmAI(question) {
    if (!ai) {
      throw new Error("AI client is not initialized. Please set your API key.");
    }

    const response = await ai.models.generateContent({
      model: "gemini-2.5-flash",
      contents: question
    });

    if (!response || !response.text) {
      throw new Error("Invalid response from Gemini API.");
    }

    // Trim trailing newline if any
    return response.text.trimEnd();
  }

  async function handleSend() {
    const question = userInput.value.trim();
    if (!question) {
      alert('Please enter a question to FarmAI.');
      return;
    }
    sendBtn.disabled = true;
    responseDiv.textContent = "Thinking...";
    try {
      const answer = await queryFarmAI(question);
      responseDiv.textContent = answer;
    } catch (error) {
      responseDiv.textContent = "Oops! Something went wrong. Please check your API key and try again.\n" + error.message;
      console.error(error);
    } finally {
      sendBtn.disabled = false;
    }
  }

  sendBtn.addEventListener('click', handleSend);
  userInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  });
</script>
</body>
</html>
